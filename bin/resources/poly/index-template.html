<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
  </head>
  <body>
  <script src="http://localhost/labcoat2/js/precog.js" type="text/javascript"></script>
  <script src="dependencies.js"></script>
  <script src="all.js"></script>

  <link rel="stylesheet" type="text/css" href="dependencies.css" />
  <link rel="stylesheet" type="text/css" href="app.css" />

  <div id="chart" class="polychart-ui"></div>
  <script>
// DYNAMIC VARIABLES
    var apiKey = "D99DFC4E-91F4-4F3A-BB07-51F0A5109F16",
        analyticsService = "https://nebula.precog.com",
        sources = [{ name : "out2", query : "//0000000094/some/out2", meta : {"name":{"type":"cat"},"age":{"type":"num"}} }, { name : "out4", query : "//0000000094/some/out4", meta : {"name":{"type":"cat"},"age":{"type":"num"}} }],
        filePath = "/0000000094/some/out5";
// END OF DYNAMIC VARIABLES

var api  = new Precog.api({ analyticsService : analyticsService, apiKey : apiKey }),
    poly = require("poly");


api.getFile(filePath).then(function(result) {
  var config = JSON.parse(result.contents);
      polychart_global = poly.dashboard({
        dom: $("#chart")[0],
        header: false,
        showTutorial: false,
        width: "fill",
        height: "fill",
        demoData: [{
          type: "precog",
          api : api,
          sources: sources
        }],
        initial : config
    });

  polychart_global.onSave((function() {
    var timer;
    return function() {
      clearTimeout(timer);
      timer = setTimeout(function() {
        var content = JSON.stringify(polychart_global.serialize());
        console.log(content);
        api.uploadFile({
          path : filePath,
          type : "application/json",
          contents : content
        }).then(function() {
          // communicate up to the iframe
        });
      }, 1000)
    };
  })());
});

  </script>
  </body>
</html>

